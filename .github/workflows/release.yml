name: Release

on:
  push:
    branches:
      - main

# é˜²æ­¢å¹¶å‘å†²çª
concurrency: ${{ github.workflow }}-${{ github.ref }}

# ğŸ”’ æƒé™é…ç½®ï¼šå¿…é¡»æœ‰å†™æƒé™æ‰èƒ½åˆ›å»º PR å’Œæ›´æ–°ç‰ˆæœ¬å·
permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. å®‰è£… pnpm (è¿™æ˜¯ä¿®å¤ "spawn pnpm ENOENT" çš„å…³é”®)
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9 # æˆ–è€…ä¿æŒè·Ÿä½ æœ¬åœ°ä¸€è‡´çš„ç‰ˆæœ¬

      # 3. é…ç½® Node ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # å¿…é¡»æŒ‡å®š registry-urlï¼Œå¦åˆ™æ— æ³•è¯»å– NODE_AUTH_TOKEN
          registry-url: 'https://registry.npmjs.org'
          # å¼€å¯ç¼“å­˜ï¼ŒåŠ é€Ÿå®‰è£…
          cache: 'pnpm'

      # 4. å®‰è£…ä¾èµ– (ä½¿ç”¨ pnpm)
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # 5. Changesets æ ¸å¿ƒæ­¥éª¤
      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # --- å‘å¸ƒå‘½ä»¤ ---
          # å¿…é¡»ä½¿ç”¨ pnpm run releaseï¼Œå› ä¸ºé¡¹ç›®é‡Œæœ‰ pnpm-lock.yaml
          publish: pnpm run release

          # --- PR ä¿¡æ¯ ---
          commit: "chore: update versions"
          title: "chore: update versions"
        env:
          # GitHub è‡ªåŠ¨ç”Ÿæˆçš„ Token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ä½ åœ¨ Secrets é‡Œé…ç½®çš„ NPM Token (å¿…é¡»å« NPM_TOKEN æˆ– NODE_AUTH_TOKEN)
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
